<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIN Customer Profiles with Camera Alert</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
  .container { max-width: 900px; margin: auto; padding: 20px; background: #fff; border-radius: 10px; }
  h2 { text-align: center; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  th { background-color: #eee; }
  #reader { width: 100%; margin-top: 10px; display: none; }
  .edit-btn, .delete-btn { padding: 5px 10px; border: none; border-radius: 3px; cursor: pointer; color: white; }
  .edit-btn { background-color: #4CAF50; }
  .delete-btn { background-color: #f44336; }
</style>
</head>
<body>

<div class="container">
  <h2>VIN Customer Profiles</h2>

  <label>Customer Name:</label>
  <input type="text" id="customerName" placeholder="Full Name">

  <label>Phone Number:</label>
  <input type="text" id="phone" placeholder="Phone Number">

  <label>Email:</label>
  <input type="text" id="email" placeholder="Email">

  <label>Plate Number:</label>
  <input type="text" id="plate" placeholder="Plate Number">

  <label>VIN Number:</label>
  <input type="text" id="vin" placeholder="Scan or enter VIN">

  <button onclick="startScannerButton()">Scan VIN</button>
  <div id="reader"></div>

  <h3>Search Customer</h3>
  <input type="text" id="searchInput" placeholder="Search by Name, VIN, or Plate" oninput="searchProfiles()">

  <h3>Saved Profiles</h3>
  <table id="profilesTable">
      <tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Actions</th>
      </tr>
  </table>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
let profiles = JSON.parse(localStorage.getItem("profiles") || "[]");
let editingIndex = null;
let scannerActive = false;

function loadProfiles() {
    const table = document.getElementById('profilesTable');
    table.innerHTML = `<tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Actions</th>
      </tr>`;
    profiles.forEach((profile, index) => addRowToTable(profile, index));
}

function addRowToTable(profile, index) {
    const table = document.getElementById('profilesTable');
    const row = table.insertRow();
    row.insertCell(0).innerText = profile.name;
    row.insertCell(1).innerText = profile.phone;
    row.insertCell(2).innerText = profile.email;
    row.insertCell(3).innerText = profile.plate;
    row.insertCell(4).innerText = profile.vin;
    row.insertCell(5).innerText = profile.vehicleInfo;
    const actionsCell = row.insertCell(6);

    const editBtn = document.createElement('button');
    editBtn.innerText = "Edit";
    editBtn.className = "edit-btn";
    editBtn.onclick = () => editProfile(index);
    actionsCell.appendChild(editBtn);

    const deleteBtn = document.createElement('button');
    deleteBtn.innerText = "Delete";
    deleteBtn.className = "delete-btn";
    deleteBtn.onclick = () => deleteProfile(index);
    actionsCell.appendChild(deleteBtn);
}

async function decodeAndSave(vin) {
    const name = document.getElementById('customerName').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const plate = document.getElementById('plate').value;

    if (!vin) return;

    let vehicleInfo = "";
    try {
        const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
        const data = await res.json();
        const result = data.Results[0];
        vehicleInfo = `${result.ModelYear} ${result.Make} ${result.Model}`;
    } catch {
        vehicleInfo = "Could not decode VIN";
    }

    const profile = {name, phone, email, plate, vin, vehicleInfo};

    if (editingIndex !== null) {
        profiles[editingIndex] = profile;
        editingIndex = null;
    } else {
        profiles.push(profile);
    }

    localStorage.setItem("profiles", JSON.stringify(profiles));
    loadProfiles();

    document.getElementById('customerName').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('email').value = '';
    document.getElementById('plate').value = '';
    document.getElementById('vin').value = '';
}

function editProfile(index) {
    const profile = profiles[index];
    document.getElementById('customerName').value = profile.name;
    document.getElementById('phone').value = profile.phone;
    document.getElementById('email').value = profile.email;
    document.getElementById('plate').value = profile.plate;
    document.getElementById('vin').value = profile.vin;
    editingIndex = index;
}

function deleteProfile(index) {
    if (confirm('Are you sure you want to delete this profile?')) {
        profiles.splice(index, 1);
        localStorage.setItem("profiles", JSON.stringify(profiles));
        loadProfiles();
    }
}

function searchProfiles() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const filtered = profiles.filter(p => 
        p.name.toLowerCase().includes(query) ||
        p.vin.toLowerCase().includes(query) ||
        p.plate.toLowerCase().includes(query)
    );
    const table = document.getElementById('profilesTable');
    table.innerHTML = `<tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Actions</th>
      </tr>`;
    filtered.forEach((profile, index) => addRowToTable(profile, index));
}

function startScannerButton() {
    const readerDiv = document.getElementById("reader");
    if (!scannerActive) {
        readerDiv.style.display = "block"; // make camera div visible
        scannerActive = true;

        try {
            const html5QrcodeScanner = new Html5Qrcode("reader");
            html5QrcodeScanner.start(
                { facingMode: "environment" },
                { fps: 10, qrbox: 250 },
                (decodedText) => {
                    document.getElementById('vin').value = decodedText;
                    decodeAndSave(decodedText);
                    html5QrcodeScanner.stop().then(() => {
                        readerDiv.style.display = "none";
                        scannerActive = false;
                    });
                },
                (errorMessage) => {
                    console.log("Scan error:", errorMessage);
                }
            ).catch(err => {
                console.error("Camera start failed:", err);
                alert("Camera access is blocked or unavailable.

Please enable it in Settings:
1. Open Settings → Safari → Camera
2. Allow camera access for this site.");
                readerDiv.style.display = "none";
                scannerActive = false;
            });
        } catch (err) {
            console.error("Scanner initialization error:", err);
            alert("Camera failed to start. Make sure you allowed camera access in Settings.");
            readerDiv.style.display = "none";
            scannerActive = false;
        }
    }
}

loadProfiles();
</script>

</body>
</html>
