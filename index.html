<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIN Customer Profiles with Edit</title>
<style>
  body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f4f4f4; }
  .container { max-width: 900px; margin: auto; padding: 20px; background: #fff; border-radius: 10px; }
  h2 { text-align: center; }
  input, button { padding: 10px; margin: 5px 0; width: 100%; border-radius: 5px; border: 1px solid #ccc; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 10px; text-align: left; }
  th { background-color: #eee; }
  #reader { width: 100%; margin-top: 10px; }
  .edit-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; cursor: pointer; border-radius: 3px; }
</style>
</head>
<body>

<div class="container">
  <h2>VIN Customer Profiles</h2>

  <label>Customer Name:</label>
  <input type="text" id="customerName" placeholder="Full Name">

  <label>Phone Number:</label>
  <input type="text" id="phone" placeholder="Phone Number">

  <label>Email:</label>
  <input type="text" id="email" placeholder="Email">

  <label>Plate Number:</label>
  <input type="text" id="plate" placeholder="Plate Number">

  <label>VIN Number:</label>
  <input type="text" id="vin" placeholder="Scan or enter VIN">

  <h3>Scan VIN Barcode</h3>
  <div id="reader"></div>

  <h3>Search Customer</h3>
  <input type="text" id="searchInput" placeholder="Search by Name, VIN, or Plate" oninput="searchProfiles()">

  <h3>Saved Profiles</h3>
  <table id="profilesTable">
      <tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Edit</th>
      </tr>
  </table>
</div>

<script src="https://unpkg.com/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script>
// LocalStorage for profiles
let profiles = JSON.parse(localStorage.getItem("profiles") || "[]");
let editingIndex = null;

// Load profiles table
function loadProfiles() {
    const table = document.getElementById('profilesTable');
    table.innerHTML = `<tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Edit</th>
      </tr>`;
    profiles.forEach((profile, index) => addRowToTable(profile, index));
}

// Add profile row
function addRowToTable(profile, index) {
    const table = document.getElementById('profilesTable');
    const row = table.insertRow();
    row.insertCell(0).innerText = profile.name;
    row.insertCell(1).innerText = profile.phone;
    row.insertCell(2).innerText = profile.email;
    row.insertCell(3).innerText = profile.plate;
    row.insertCell(4).innerText = profile.vin;
    row.insertCell(5).innerText = profile.vehicleInfo;
    const editCell = row.insertCell(6);
    const editBtn = document.createElement('button');
    editBtn.innerText = "Edit";
    editBtn.className = "edit-btn";
    editBtn.onclick = () => editProfile(index);
    editCell.appendChild(editBtn);
}

// Decode VIN and save profile
async function decodeAndSave(vin) {
    const name = document.getElementById('customerName').value;
    const phone = document.getElementById('phone').value;
    const email = document.getElementById('email').value;
    const plate = document.getElementById('plate').value;

    if (!vin) return;

    let vehicleInfo = "";
    try {
        const res = await fetch(`https://vpic.nhtsa.dot.gov/api/vehicles/decodevinvalues/${vin}?format=json`);
        const data = await res.json();
        const result = data.Results[0];
        vehicleInfo = `${result.ModelYear} ${result.Make} ${result.Model}`;
    } catch {
        vehicleInfo = "Could not decode VIN";
    }

    const profile = {name, phone, email, plate, vin, vehicleInfo};

    if (editingIndex !== null) {
        profiles[editingIndex] = profile;
        editingIndex = null;
    } else {
        profiles.push(profile);
    }

    localStorage.setItem("profiles", JSON.stringify(profiles));
    loadProfiles();

    // Clear input fields
    document.getElementById('customerName').value = '';
    document.getElementById('phone').value = '';
    document.getElementById('email').value = '';
    document.getElementById('plate').value = '';
    document.getElementById('vin').value = '';
}

// Edit profile
function editProfile(index) {
    const profile = profiles[index];
    document.getElementById('customerName').value = profile.name;
    document.getElementById('phone').value = profile.phone;
    document.getElementById('email').value = profile.email;
    document.getElementById('plate').value = profile.plate;
    document.getElementById('vin').value = profile.vin;
    editingIndex = index;
}

// Search profiles
function searchProfiles() {
    const query = document.getElementById('searchInput').value.toLowerCase();
    const filtered = profiles.filter(p => 
        p.name.toLowerCase().includes(query) ||
        p.vin.toLowerCase().includes(query) ||
        p.plate.toLowerCase().includes(query)
    );
    const table = document.getElementById('profilesTable');
    table.innerHTML = `<tr>
          <th>Customer</th>
          <th>Phone</th>
          <th>Email</th>
          <th>Plate</th>
          <th>VIN</th>
          <th>Vehicle Info</th>
          <th>Edit</th>
      </tr>`;
    filtered.forEach((profile, index) => addRowToTable(profile, index));
}

// Start VIN scanner
function startScanner() {
    const html5QrcodeScanner = new Html5Qrcode("reader");
    html5QrcodeScanner.start(
        { facingMode: "environment" },
        { fps: 10, qrbox: 250 },
        (decodedText) => {
            document.getElementById('vin').value = decodedText;
            decodeAndSave(decodedText); // automatically decode and save
        },
        (errorMessage) => { /* ignore scan errors */ }
    );
}

// Initialize
loadProfiles();
startScanner();
</script>

</body>
</html>
